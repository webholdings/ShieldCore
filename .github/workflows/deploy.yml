name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Cache Functions Dependencies
        uses: actions/cache@v3
        with:
          path: functions/node_modules
          key: ${{ runner.os }}-functions-${{ hashFiles('functions/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-functions-

      - name: Install Dependencies
        run: |
          npm install
          cd functions && npm install

      - name: Create Env File
        run: |
          echo "NODE_ENV=production" > functions/.env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> functions/.env
          echo "WOOCOMMERCE_URL=${{ secrets.WOOCOMMERCE_URL }}" >> functions/.env
          echo "WOOCOMMERCE_CONSUMER_KEY=${{ secrets.WOOCOMMERCE_CONSUMER_KEY }}" >> functions/.env
          echo "WOOCOMMERCE_CONSUMER_SECRET=${{ secrets.WOOCOMMERCE_CONSUMER_SECRET }}" >> functions/.env
          echo "WOOCOMMERCE_WEBHOOK_SECRET=${{ secrets.WOOCOMMERCE_WEBHOOK_SECRET }}" >> functions/.env

      - name: Build Client
        run: npm run build

      - name: Build Functions
        run: |
          cd functions
          echo "=== Before build ==="
          ls -la lib/ || echo "lib folder does not exist yet"
          npm run build:local
          echo "=== After build ==="
          ls -la lib/
          echo "=== File size of index.cjs ==="
          wc -c lib/index.cjs

          echo "=== Transforming package to standard CommonJS ==="
          # 1. Remove "type": "module" (so .js is CJS)
          # 2. Remove build scripts (so Cloud Build doesn't fail)
          # 3. Point main to "index.js" (standard entry point)
          node -e "const p = require('./package.json'); delete p.type; delete p.scripts.build; delete p.scripts['build:local']; p.main = 'index.js'; require('fs').writeFileSync('package.json', JSON.stringify(p, null, 2));"
          
          # Create index.js proxy that requires the bundled file
          echo "module.exports = require('./lib/index.cjs');" > index.js
          
          echo "=== Final package.json ==="
          cat package.json
          echo "=== Final index.js ==="
          cat index.js

      - name: Create SA Key
        run: echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > service-account.json

      - name: Verify Functions Package
        run: |
          echo "=== Functions directory ==="
          ls -la functions/
          echo "=== Functions lib ==="
          ls -la functions/lib/
          echo "=== Checking admin routes in bundle ==="
          grep -c "admin/users" functions/lib/index.cjs || echo "ADMIN ROUTES NOT FOUND!"
          echo "=== Functions package.json main ==="
          cat functions/package.json | grep -A2 '"main"'

      - name: Deploy to Firebase
        run: |
          npx firebase-tools deploy --project creativewavesapp2 --only functions,hosting --non-interactive --force --debug 2>&1 | tail -100
        env:
          GOOGLE_APPLICATION_CREDENTIALS: service-account.json
